--- charts-original/templates/prometheus/prometheus.yaml
+++ charts/templates/prometheus/prometheus.yaml
@@ -50,7 +50,7 @@
 {{ toYaml .Values.prometheus.prometheusSpec.apiserverConfig | indent 4}}
 {{- end }}
 {{- if .Values.prometheus.prometheusSpec.image }}
-  {{- $registry := .Values.global.imageRegistry | default .Values.prometheus.prometheusSpec.image.registry -}}
+  {{- $registry := include "monitoring_registry" . | default .Values.prometheus.prometheusSpec.image.registry -}}
   {{- if and .Values.prometheus.prometheusSpec.image.tag .Values.prometheus.prometheusSpec.image.sha }}
   image: "{{ $registry }}/{{ .Values.prometheus.prometheusSpec.image.repository }}:{{ .Values.prometheus.prometheusSpec.image.tag }}@sha256:{{ .Values.prometheus.prometheusSpec.image.sha }}"
   {{- else if .Values.prometheus.prometheusSpec.image.sha }}
@@ -88,11 +88,13 @@
   externalUrl: "{{ tpl .Values.prometheus.prometheusSpec.externalUrl . }}"
 {{- else if and .Values.prometheus.ingress.enabled .Values.prometheus.ingress.hosts }}
   externalUrl: "http://{{ tpl (index .Values.prometheus.ingress.hosts 0) . }}{{ .Values.prometheus.prometheusSpec.routePrefix }}"
+{{- else if not (or (kindIs "invalid" .Values.global.cattle.url) (kindIs "invalid" .Values.global.cattle.clusterId)) }}
+  externalUrl: "{{ .Values.global.cattle.url }}/k8s/clusters/{{ .Values.global.cattle.clusterId }}/api/v1/namespaces/{{ template "kube-prometheus-stack.namespace" . }}/services/http:{{ template "kube-prometheus-stack.fullname" . }}-prometheus:{{ .Values.prometheus.service.port }}/proxy"
 {{- else }}
   externalUrl: http://{{ template "kube-prometheus-stack.fullname" . }}-prometheus.{{ template "kube-prometheus-stack.namespace" . }}:{{ .Values.prometheus.service.port }}
 {{- end }}
+  nodeSelector: {{ include "linux-node-selector" . | nindent 4 }}
 {{- if .Values.prometheus.prometheusSpec.nodeSelector }}
-  nodeSelector:
 {{ toYaml .Values.prometheus.prometheusSpec.nodeSelector | indent 4 }}
 {{- end }}
   paused: {{ .Values.prometheus.prometheusSpec.paused }}
@@ -183,7 +185,9 @@
   serviceName: {{ tpl .Values.prometheus.prometheusSpec.serviceName  .}}
 {{- end }}
   serviceAccountName: {{ template "kube-prometheus-stack.prometheus.serviceAccountName" . }}
-{{- if .Values.prometheus.prometheusSpec.serviceMonitorSelector }}
+{{- if.Values.prometheus.disableServiceDiscovery }}
+  serviceMonitorSelect : null
+{{- else if .Values.prometheus.prometheusSpec.serviceMonitorSelector }}
   serviceMonitorSelector:
 {{ tpl (toYaml .Values.prometheus.prometheusSpec.serviceMonitorSelector | indent 4) . }}
 {{ else if .Values.prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues  }}
@@ -199,7 +203,9 @@
 {{ else }}
   serviceMonitorNamespaceSelector: {}
 {{- end }}
-{{- if .Values.prometheus.prometheusSpec.podMonitorSelector }}
+{{- if .Values.prometheus.disableServiceDiscovery }}
+  podMonitorSelector : null
+{{- else if .Values.prometheus.prometheusSpec.podMonitorSelector }}
   podMonitorSelector:
 {{ tpl (toYaml .Values.prometheus.prometheusSpec.podMonitorSelector | indent 4) . }}
 {{ else if .Values.prometheus.prometheusSpec.podMonitorSelectorNilUsesHelmValues  }}
@@ -215,7 +221,9 @@
 {{ else }}
   podMonitorNamespaceSelector: {}
 {{- end }}
-{{- if .Values.prometheus.prometheusSpec.probeSelector }}
+{{- if .Values.prometheus.disableServiceDiscovery }}
+  probeSelector : null
+{{- else if .Values.prometheus.prometheusSpec.probeSelector }}
   probeSelector:
 {{ tpl (toYaml .Values.prometheus.prometheusSpec.probeSelector | indent 4) . }}
 {{ else if .Values.prometheus.prometheusSpec.probeSelectorNilUsesHelmValues  }}
@@ -333,8 +341,8 @@
 {{- include "kube-prometheus-stack.prometheus.pod-anti-affinity.matchExpressions" . | indent 12 }}
 {{- end }}
 {{- end }}
+  tolerations: {{ include "linux-node-tolerations" . | nindent 4 }}
 {{- if .Values.prometheus.prometheusSpec.tolerations }}
-  tolerations:
 {{ toYaml .Values.prometheus.prometheusSpec.tolerations | indent 4 }}
 {{- end }}
 {{- if .Values.prometheus.prometheusSpec.topologySpreadConstraints }}
@@ -383,7 +391,7 @@
 {{- end }}
 {{- if .Values.prometheus.prometheusSpec.containers }}
   containers:
-{{ toYaml .Values.prometheus.prometheusSpec.containers | indent 4 }}
+{{ tpl .Values.prometheus.prometheusSpec.containers $ | indent 4 }}
 {{- end }}
 {{- if .Values.prometheus.prometheusSpec.initContainers }}
   initContainers:
